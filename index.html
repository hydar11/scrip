<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shop Chest</title>
  <meta name="viewport" content="width=600, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #232526 0%, #414345 100%);
      color: #f3f3f3;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .shop-header {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      padding: 2em 0 1em 0;
      text-align: center;
      box-shadow: 0 2px 8px #0003;
    }
    .shop-header h1 {
      font-size: 2.7em;
      margin: 0 0 0.2em 0;
      letter-spacing: 2px;
      color: #fff;
      text-shadow: 0 2px 8px #0005;
    }
    .shop-header p {
      font-size: 1.2em;
      color: #e0e0e0;
      margin: 0;
      opacity: 0.85;
    }
    .container {
      flex: 1;
      max-width: 700px;
      margin: 0 auto;
      padding: 2em 1em 1em 1em;
    }
    .trade-grid {
      display: grid;
      gap: 2em;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      margin-top: 2em;
    }
    .trade-card {
      background: #292b2f;
      border-radius: 18px;
      box-shadow: 0 4px 24px #0005;
      padding: 2em 1.5em 1.5em 1.5em;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      overflow: hidden;
      border: 1px solid #393b40;
      animation: fadeInUp 0.7s cubic-bezier(.39,.575,.56,1.000);
    }
    .trade-card:hover {
      transform: translateY(-6px) scale(1.03);
      box-shadow: 0 8px 32px #0007;
      border-color: #764ba2;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .trade-title {
      font-size: 1.4em;
      margin-bottom: 0.3em;
      color: #a991e4;
      font-weight: 600;
      letter-spacing: 1px;
    }
    .trade-desc {
      font-size: 1em;
      margin-bottom: 1.2em;
      color: #bdbdbd;
      font-style: italic;
    }
    .trade-exchange {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 1.2em 0 1.5em 0;
      padding: 1em;
      background: #232326;
      border-radius: 10px;
      box-shadow: 0 2px 8px #0002;
    }
    .trade-item {
      text-align: center;
      flex: 1;
    }
    .trade-arrow {
      font-size: 2em;
      color: #667eea;
      margin: 0 18px;
      font-weight: bold;
      text-shadow: 0 1px 4px #0003;
    }
    .item-name {
      font-weight: bold;
      color: #fff;
      font-size: 1.1em;
      margin-bottom: 0.2em;
    }
    .item-amount {
      color: #bdbdbd;
      font-size: 0.95em;
    }
    .trade-button {
      width: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 14px 0;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: bold;
      transition: all 0.2s;
      margin-top: 0.5em;
      box-shadow: 0 2px 8px #0002;
    }
    .trade-button:hover {
      background: linear-gradient(90deg, #5a67d8, #6b46c1);
      transform: translateY(-2px) scale(1.01);
    }
    .trade-button:active {
      transform: translateY(0);
    }
    .status-message {
      margin: 1.5em 0 0.5em 0;
      padding: 1em;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      font-size: 1.05em;
      background: #232326;
      color: #a991e4;
      border: 1px solid #393b40;
      box-shadow: 0 2px 8px #0002;
    }
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1em;
      padding: 0.5em 1em;
      background: #232326;
      border-radius: 8px;
      box-shadow: 0 2px 8px #0002;
    }
    .btn-secondary {
      background: #4a5568;
      color: #e0e0e0;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: bold;
      transition: background 0.2s;
    }
    .btn-secondary:hover {
      background: #3a404a;
    }
    footer {
      text-align: center;
      color: #bdbdbd;
      font-size: 0.95em;
      padding: 1.5em 0 1em 0;
      background: none;
      letter-spacing: 1px;
    }
    @media (max-width: 700px) {
      .container {
        padding: 1em 0.2em;
      }
      .trade-grid {
        grid-template-columns: 1fr;
      }
      .trade-exchange {
        flex-direction: column;
        gap: 10px;
      }
      .trade-arrow {
        transform: rotate(90deg);
      }
    }
  </style>
</head>
<body>
  <div class="shop-header">
    <h1>üè™ Shop Chest</h1>
    <p>Trade your items and ETH in the marketplace</p>
  </div>
  <div class="container">
    <div class="status-bar">
        <div id="status">Ready to trade</div>
        <button onclick="setChestEntityId()" class="btn-secondary">Set Chest ID</button>
        <button onclick="extractEntityFromConsoleLog()" class="btn-secondary">Use Known Chest</button>
        <button onclick="setPlayerEntityId()" class="btn-secondary">Set Player ID</button>
    </div>
    <div class="trade-grid" id="trades-container"></div>
  </div>
  <footer>
    &copy; 2024 Shop Chest &mdash; Powered by Dust/MUD
  </footer>
  <script>
    // Trade configuration
    const trades = [
      {
        id: "pumpkin-soup",
        name: "Pumpkin ‚Üí Soup",
        description: "Transform your pumpkin into delicious soup",
        input: {
          type: "item",
          item: "Pumpkin",
          amount: 1,
          objectType: 94,
          emoji: "üéÉ"
        },
        output: {
          type: "item",
          item: "PumpkinSoup",
          amount: 1,
          objectType: 32791,
          emoji: "üç≤"
        },
        ethRequired: 0
      },
      {
        id: "eth-pumpkin",
        name: "ETH ‚Üí Pumpkin",
        description: "Buy a fresh pumpkin with ETH",
        input: {
          type: "eth",
          amount: "0.000001",
          weiAmount: 1000000000000,
          emoji: "üíé"
        },
        output: {
          type: "item",
          item: "Pumpkin",
          amount: 1,
          objectType: 94,
          emoji: "üéÉ"
        },
        ethRequired: 1000000000000
      }
    ];

    // Access Dust context for entity information
    function getDustContext() {
      // Try different ways Dust might provide context
      const context = window.dust?.entityContext || 
             window.dust?.context || 
             window.dust?.entity ||
             window.dust?.appContext ||
             {};
      
      // Check URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const urlEntityId = urlParams.get('entity') || urlParams.get('entityId') || urlParams.get('id');
      
      // Check for global variables
      const globalEntityId = window.entityId || window.currentEntityId || window.targetEntityId;
      
      // Check for any global Dust-related objects
      const globalDust = window.dust || window.Dust || window.DUST;
      
      // Check for entity data that might be stored globally
      const globalEntityData = window.entityData || window.currentEntity || window.selectedEntity;
      
      console.log("URL parameters:", Object.fromEntries(urlParams.entries()));
      console.log("Global entity ID:", globalEntityId);
      console.log("Global Dust object:", globalDust);
      console.log("Global entity data:", globalEntityData);
      
      // Return context with any found entity ID
      return {
        ...context,
        entityId: context.entityId || urlEntityId || globalEntityId || globalEntityData?.entityId,
        urlParams: Object.fromEntries(urlParams.entries())
      };
    }

    // Get entity IDs from Dust context or manual input
    function getEntityIds() {
      // Always use the known chest entity ID
      chestEntityId = '0x03000002bd000000b5fffff97800000000000000000000000000000000000000';
      console.log("Using chest entity ID:", chestEntityId);
      
      // Try to get player entity ID from world contract
      getPlayerEntityId();
      
      return true;
    }
    
    // Get player entity ID from world contract
    async function getPlayerEntityId() {
      try {
        if (!world) {
          console.log("World contract not available");
          return;
        }
        
        // Try to get player entity ID from world contract
        // This might be stored in a specific table or accessible via a function
        console.log("Attempting to get player entity ID from world contract...");
        
        // For now, we'll need to get this manually or from the game state
        updateStatus("‚ÑπÔ∏è Please set player entity ID manually if needed");
        
      } catch (error) {
        console.error("Error getting player entity ID:", error);
      }
    }

    // Access the world object if available
    function getWorld() {
      return window.world || window.dust?.world;
    }

    function showStatus(message, type = 'success') {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status-message">${message}</div>`;
      setTimeout(() => {
        statusDiv.innerHTML = '';
      }, 4000);
    }

    async function executeTrade(tradeId) {
      const trade = trades.find(t => t.id === tradeId);
      if (!trade) {
        showStatus('Trade not found!');
        return;
      }

      const button = document.querySelector(`[data-trade-id="${tradeId}"]`);
      button.disabled = true;
      button.textContent = 'Processing...';

      try {
        // Get entity context from Dust
        const chestEntityId = getChestEntityId();
        const playerEntityId = getPlayerEntityId();
        const world = getWorld();

        console.log("Chest Entity ID:", chestEntityId);
        console.log("Player Entity ID:", playerEntityId);
        console.log("World object:", world);

        if (!chestEntityId) {
          showStatus('‚ùå Error: Could not get chest entity ID from Dust context');
          return;
        }

        if (!world) {
          showStatus('‚ùå Error: Could not access world object');
          return;
        }

        // Find player's Pumpkin in inventory
        const pumpkinSlot = await findPumpkinSlot(world, playerEntityId);
        
        if (pumpkinSlot === null) {
          showStatus('‚ùå You need Pumpkin to make this trade!');
          return;
        }

        // Execute the trade using transferAmounts
        if (trade.input.type === 'item') {
          // Item trade (Pumpkin ‚Üí PumpkinSoup)
          await world.write("transferAmounts", 
            playerEntityId, // caller
            playerEntityId, // from (player inventory)
            chestEntityId,  // to (chest)
            [[pumpkinSlot, trade.input.amount]] // [slot, amount]
          );
        } else {
          // ETH trade (ETH ‚Üí Pumpkin)
          await world.write("transferAmounts", 
            playerEntityId, // caller
            playerEntityId, // from (player inventory)
            chestEntityId,  // to (chest)
            [], // no items transferred (ETH is sent separately)
            { value: trade.ethRequired } // ETH amount
          );
        }

        showStatus(`‚úÖ Trade completed! You exchanged ${trade.input.emoji} ${trade.input.type === 'item' ? trade.input.amount + 'x ' + trade.input.item : trade.input.amount + ' ETH'} for ${trade.output.emoji} ${trade.output.amount}x ${trade.output.item}`);

      } catch (error) {
        console.error("Trade error:", error);
        showStatus('‚ùå Trade failed: ' + (error.message || 'Unknown error'));
      } finally {
        button.disabled = false;
        button.textContent = 'Make Trade';
      }
    }

    // Function to find Pumpkin in player's inventory
    async function findPumpkinSlot(world, playerEntityId) {
      try {
        // Use the working inventory scanning code
        for (let i = 0; i < 36; i++) {
          try {
            const encodedSlot = "0x" + i.toString(16).padStart(64, '0');
            const slotData = await world.read("getRecord", 
              "0x74620000000000000000000000000000496e76656e746f7279536c6f74000000",
              [playerEntityId, encodedSlot],
            );
            
            const staticData = slotData[0];
            const amount = decodeUint16(staticData);
            const objectType = decodeObjectType(staticData);
            
            if (objectType === 94 && amount > 0) { // Pumpkin ID
              return i;
            }
          } catch (error) {
            // Skip errors
          }
        }
        return null; // No Pumpkin found
      } catch (error) {
        console.error("Error finding Pumpkin:", error);
        return null;
      }
    }

    // Helper functions for decoding inventory data
    function decodeUint16(bytesHex) {
      if (bytesHex === '0x') return 0;
      const last4Chars = bytesHex.slice(-4);
      return parseInt(last4Chars, 16);
    }

    function decodeObjectType(staticData) {
      if (staticData === '0x') return 0;
      const objectTypeHex = staticData.slice(-8, -4);
      return parseInt(objectTypeHex, 16);
    }

    function renderTrades() {
      const container = document.getElementById('trades-container');
      const tradesHTML = trades.map(trade => `
        <div class="trade-card">
          <div class="trade-title">${trade.name}</div>
          <div class="trade-desc">${trade.description}</div>
          <div class="trade-exchange">
            <div class="trade-item">
              <div class="item-name">${trade.input.emoji} ${trade.input.type === 'item' ? trade.input.item : 'ETH'}</div>
              <div class="item-amount">${trade.input.type === 'item' ? trade.input.amount + 'x' : trade.input.amount}</div>
            </div>
            <div class="trade-arrow">‚Üí</div>
            <div class="trade-item">
              <div class="item-name">${trade.output.emoji} ${trade.output.item}</div>
              <div class="item-amount">${trade.output.amount}x</div>
            </div>
          </div>
          <button class="trade-button" data-trade-id="${trade.id}" onclick="executeTrade('${trade.id}')">
            Make Trade
          </button>
        </div>
      `).join('');
      container.innerHTML = tradesHTML;
    }

    // Listen for Dust events
    function setupDustEventListeners() {
      window.addEventListener('message', (event) => {
        console.log("Received message:", event.data);
        if (event.data.type === 'entity-context' || event.data.entityId) {
          console.log("Entity context from message:", event.data);
          updateEntityContext(event.data);
        }
      });

      // Listen for custom events
      window.addEventListener('dust-entity-context', (event) => {
        console.log("Dust entity context event:", event.detail);
        updateEntityContext(event.detail);
      });

      // Listen for any Dust-related events
      window.addEventListener('dust-entity-selected', (event) => {
        console.log("Dust entity selected:", event.detail);
        updateEntityContext(event.detail);
      });
    }

    // Update entity context when received
    function updateEntityContext(context) {
      if (context.entityId) {
        chestEntityId = context.entityId;
        console.log("Updated chest entity ID:", chestEntityId);
        updateStatus(`Chest Entity ID: ${chestEntityId}`);
      }
    }

    // Manual chest entity ID input (fallback)
    function setChestEntityId() {
      const input = prompt("Enter chest entity ID (hex format):");
      if (input && input.startsWith('0x')) {
        chestEntityId = input;
        updateStatus(`Chest Entity ID set to: ${chestEntityId}`);
        console.log("Manually set chest entity ID:", chestEntityId);
        
        // Reinitialize UI with the new chest entity ID
        initializeUI();
      }
    }

    // Manual player entity ID input
    function setPlayerEntityId() {
      const input = prompt("Enter player entity ID (hex format):");
      if (input && input.startsWith('0x')) {
        playerEntityId = input;
        updateStatus(`Player Entity ID set to: ${playerEntityId}`);
        console.log("Manually set player entity ID:", playerEntityId);
        
        // Reinitialize UI with the new player entity ID
        initializeUI();
      }
    }

    // Extract entity ID from Dust console log data
    function extractEntityFromConsoleLog() {
      // The entity ID from your console log
      const entityId = '0x03000002bd000000b5fffff97800000000000000000000000000000000000000';
      
      if (entityId) {
        chestEntityId = entityId;
        updateStatus(`Chest Entity ID extracted: ${chestEntityId}`);
        console.log("Extracted chest entity ID:", chestEntityId);
        
        // Reinitialize UI with the extracted chest entity ID
        initializeUI();
        return true;
      }
      return false;
    }

    // Initialize the UI
    async function initializeUI() {
      try {
        console.log("Initializing Shop Chest UI...");
        
        // Always use the known chest entity ID
        getEntityIds();
        
        // Initialize world contract
        await initializeWorldContract();
        
        console.log("Chest Entity ID:", chestEntityId);
        console.log("Player Entity ID:", playerEntityId);
        console.log("World object:", world);
        
        // Load trades
        loadTrades();
        showStatus('üè™ Shop Chest is ready for trading!');
        
      } catch (error) {
        console.error("Error initializing UI:", error);
        showStatus('‚ùå Error initializing UI: ' + error.message);
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      initializeUI();
      
      // Log Dust context for debugging
      const context = getDustContext();
      console.log("Dust context on load:", context);
      
      if (context.entityId) {
        showStatus(`üè™ Shop Chest ready! Entity ID: ${context.entityId}`);
      } else {
        showStatus('üè™ Shop Chest is ready for trading!');
      }

      // Setup Dust event listeners
      setupDustEventListeners();
      
      // Debug: Check what's available globally
      console.log("Global window object keys:", Object.keys(window).filter(key => 
        key.toLowerCase().includes('dust') || 
        key.toLowerCase().includes('entity') || 
        key.toLowerCase().includes('world') ||
        key.toLowerCase().includes('game')
      ));
      
      // Try to get context after a delay (Dust might load context asynchronously)
      setTimeout(() => {
        console.log("Delayed Dust context check:");
        const delayedContext = getDustContext();
        console.log("Delayed context:", delayedContext);
        
        if (delayedContext.entityId) {
          chestEntityId = delayedContext.entityId;
          updateStatus(`Chest Entity ID: ${chestEntityId}`);
        }
      }, 1000);
    });
  </script>
</body>
</html> 
