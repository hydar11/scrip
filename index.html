<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dust Connection Test - Fixed</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .loading { background: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .test-section {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 4px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Dust Connection Test - Fixed</h1>
        
        <div id="status" class="status disconnected">
            –°—Ç–∞—Ç—É—Å: –û—Ç–∫–ª—é—á–µ–Ω–æ
        </div>
        
        <div class="test-section">
            <h3>1. –ë–∞–∑–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h3>
            <button id="connectBtn" onclick="testBasicConnection()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Dust</button>
            <button id="checkContextBtn" onclick="checkAppContext()" disabled>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç</button>
        </div>
        
        <div class="test-section">
            <h3>2. –ü—Ä–æ—Å—Ç—ã–µ API –≤—ã–∑–æ–≤—ã (—Å —Ç–∞–π–º–∞—É—Ç–æ–º)</h3>
            <button id="getPositionBtn" onclick="testGetPlayerPosition()" disabled>–ü–æ–ª—É—á–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –∏–≥—Ä–æ–∫–∞</button>
            <button id="setWaypointBtn" onclick="testSetWaypoint()" disabled>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—É—Ç–µ–≤—É—é —Ç–æ—á–∫—É</button>
            <button id="getSlotsBtn" onclick="testGetSlots()" disabled>–ü–æ–ª—É—á–∏—Ç—å —Å–ª–æ—Ç—ã –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è</button>
        </div>
        
        <div class="test-section">
            <h3>3. –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞</h3>
            <button id="testSystemCallBtn" onclick="testSystemCall()" disabled>–¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞</button>
        </div>
        
        <h3>üìã –õ–æ–≥ —Ç–µ—Å—Ç–æ–≤:</h3>
        <div id="log" class="log">–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é...</div>
    </div>

    <script type="module">
        let dustClient = null;
        let appContext = null;
        let messagePort = null;

        // –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(status, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${status}`;
            statusDiv.textContent = `–°—Ç–∞—Ç—É—Å: ${message}`;
        }

        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫
        function enableButtons() {
            document.getElementById('checkContextBtn').disabled = false;
            document.getElementById('getPositionBtn').disabled = false;
            document.getElementById('setWaypointBtn').disabled = false;
            document.getElementById('getSlotsBtn').disabled = false;
            document.getElementById('testSystemCallBtn').disabled = false;
        }

        // 1. –ë–ê–ó–û–í–û–ï –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï
        window.testBasicConnection = async function() {
            try {
                updateStatus('loading', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
                log('üîå –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Dust –∫–ª–∏–µ–Ω—Ç—É...');

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ iframe
                if (window.parent === window) {
                    throw new Error('‚ùå –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω–æ –≤ iframe –≤–Ω—É—Ç—Ä–∏ Dust –∫–ª–∏–µ–Ω—Ç–∞');
                }

                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ postMessage
                const channel = new MessageChannel();
                
                const connectionPromise = new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('‚è∞ –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (5 —Å–µ–∫—É–Ω–¥)'));
                    }, 5000);

                    channel.port1.addEventListener('message', (event) => {
                        clearTimeout(timeout);
                        log('üì® –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç Dust –∫–ª–∏–µ–Ω—Ç–∞');
                        if (event.data && event.data.dustkit) {
                            resolve(event.data);
                        } else {
                            reject(new Error('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç Dust –∫–ª–∏–µ–Ω—Ç–∞'));
                        }
                    }, { once: true });
                });

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                channel.port1.start();
                window.parent.postMessage({
                    dustkit: '0.0.0', // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Ä—Å–∏—é –∫–ª–∏–µ–Ω—Ç–∞
                    context: null
                }, '*', [channel.port2]);

                const response = await connectionPromise;
                appContext = response.context;
                messagePort = channel.port1; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Ä—Ç –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
                
                updateStatus('connected', '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Dust –∫–ª–∏–µ–Ω—Ç—É');
                log('‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ Dust –∫–ª–∏–µ–Ω—Ç—É!');
                log(`üìã –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ${JSON.stringify(appContext, null, 2)}`);
                
                enableButtons();

            } catch (error) {
                updateStatus('disconnected', '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`);
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Dust:', error);
            }
        };

        // 2. –ü–†–û–í–ï–†–ö–ê –ö–û–ù–¢–ï–ö–°–¢–ê
        window.checkAppContext = function() {
            if (!appContext) {
                log('‚ùå –ù–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
                return;
            }
            
            log('üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ:');
            log(`   ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ${appContext.id}`);
            log(`   –ê–¥—Ä–µ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${appContext.userAddress}`);
            log(`   –ê–¥—Ä–µ—Å –º–∏—Ä–∞: ${appContext.worldAddress}`);
            log(`   Chain ID: ${appContext.chainId}`);
            log(`   –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: ${JSON.stringify(appContext.config, null, 2)}`);
            
            if (appContext.via) {
                log(`   –û—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑: entity=${appContext.via.entity}, program=${appContext.via.program}`);
            }
        };

        // 3. –¢–ï–°–¢ –ü–û–õ–£–ß–ï–ù–ò–Ø –ü–û–ó–ò–¶–ò–ò –ò–ì–†–û–ö–ê (—Å —Ç–∞–π–º–∞—É—Ç–æ–º)
        window.testGetPlayerPosition = async function() {
            if (!appContext || !messagePort) {
                log('‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Dust –∫–ª–∏–µ–Ω—Ç—É');
                return;
            }

            try {
                log('üìç –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∏–≥—Ä–æ–∫–∞...');
                
                const response = await sendRpcRequestWithTimeout({
                    method: "getPlayerPosition",
                    params: {
                        entity: appContext.userAddress
                    }
                }, 10000); // 10 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
                
                if (response.success) {
                    const position = response.result;
                    log(`‚úÖ –ü–æ–∑–∏—Ü–∏—è –∏–≥—Ä–æ–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞: x=${position.x}, y=${position.y}, z=${position.z}`);
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏: ${response.error}`);
                }

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–∏: ${error.message}`);
            }
        };

        // 4. –¢–ï–°–¢ –£–°–¢–ê–ù–û–í–ö–ò –ü–£–¢–ï–í–û–ô –¢–û–ß–ö–ò (—Å —Ç–∞–π–º–∞—É—Ç–æ–º)
        window.testSetWaypoint = async function() {
            if (!appContext || !messagePort) {
                log('‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Dust –∫–ª–∏–µ–Ω—Ç—É');
                return;
            }

            try {
                log('üéØ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Ç–µ–≤—É—é —Ç–æ—á–∫—É...');
                
                const response = await sendRpcRequestWithTimeout({
                    method: "setWaypoint",
                    params: {
                        entity: appContext.userAddress,
                        label: `–¢–µ—Å—Ç–æ–≤–∞—è —Ç–æ—á–∫–∞ ${Date.now()}`
                    }
                }, 10000); // 10 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
                
                if (response.success) {
                    log('‚úÖ –ü—É—Ç–µ–≤–∞—è —Ç–æ—á–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—É—Ç–µ–≤–æ–π —Ç–æ—á–∫–∏: ${response.error}`);
                }

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—É—Ç–µ–≤–æ–π —Ç–æ—á–∫–∏: ${error.message}`);
            }
        };

        // 5. –¢–ï–°–¢ –ü–û–õ–£–ß–ï–ù–ò–Ø –°–õ–û–¢–û–í (—Å —Ç–∞–π–º–∞—É—Ç–æ–º)
        window.testGetSlots = async function() {
            if (!appContext || !messagePort) {
                log('‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Dust –∫–ª–∏–µ–Ω—Ç—É');
                return;
            }

            try {
                log('üì¶ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ª–æ—Ç—ã –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è...');
                
                const response = await sendRpcRequestWithTimeout({
                    method: "getSlots",
                    params: {
                        entity: appContext.userAddress,
                        objectType: 1, // —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞
                        amount: 1,
                        operationType: "withdraw"
                    }
                }, 10000); // 10 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
                
                if (response.success) {
                    const slots = response.result.slots;
                    log(`‚úÖ –ü–æ–ª—É—á–µ–Ω—ã —Å–ª–æ—Ç—ã: ${JSON.stringify(slots, null, 2)}`);
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª–æ—Ç–æ–≤: ${response.error}`);
                }

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ª–æ—Ç–æ–≤: ${error.message}`);
            }
        };

        // 6. –¢–ï–°–¢ –°–ò–°–¢–ï–ú–ù–û–ì–û –í–´–ó–û–í–ê (—Å —Ç–∞–π–º–∞—É—Ç–æ–º)
        window.testSystemCall = async function() {
            if (!appContext || !messagePort) {
                log('‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Dust –∫–ª–∏–µ–Ω—Ç—É');
                return;
            }

            try {
                log('üîß –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤...');
                
                // –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤
                const response = await sendSystemCallWithTimeout({
                    systemId: "0x0000000000000000000000000000000000000000000000000000000000000001",
                    abi: [{
                        type: "function",
                        name: "test",
                        inputs: [],
                        outputs: [],
                        stateMutability: "view"
                    }],
                    functionName: "test",
                    args: []
                }, 15000); // 15 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
                
                if (response.success) {
                    log('‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                    log(`üìã –†–µ–∑—É–ª—å—Ç–∞—Ç: ${JSON.stringify(response.result, null, 2)}`);
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞: ${response.error}`);
                }

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–º –≤—ã–∑–æ–≤–µ: ${error.message}`);
            }
        };

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ç–∞–π–º–∞—É—Ç–æ–º
        async function sendRpcRequestWithTimeout(request, timeoutMs = 10000) {
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error(`‚è∞ –¢–∞–π–º–∞—É—Ç RPC –∑–∞–ø—Ä–æ—Å–∞ (${timeoutMs}ms): ${request.method}`));
                }, timeoutMs);

                const requestId = Math.random().toString(36);
                request.id = requestId;
                
                log(`üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º RPC –∑–∞–ø—Ä–æ—Å: ${request.method} (ID: ${requestId})`);
                
                messagePort.addEventListener('message', function onMessage(event) {
                    if (event.data && event.data.id === requestId) {
                        clearTimeout(timeout);
                        messagePort.removeEventListener('message', onMessage);
                        
                        log(`üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –Ω–∞ ${request.method}: ${JSON.stringify(event.data, null, 2)}`);
                        
                        resolve({
                            success: !event.data.error,
                            result: event.data.result,
                            error: event.data.error?.message
                        });
                    }
                });
                
                messagePort.postMessage({
                    jsonrpc: "2.0",
                    id: requestId,
                    method: request.method,
                    params: request.params
                });
            });
        }

        async function sendSystemCallWithTimeout(systemCall, timeoutMs = 15000) {
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error(`‚è∞ –¢–∞–π–º–∞—É—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ (${timeoutMs}ms): ${systemCall.functionName}`));
                }, timeoutMs);

                const requestId = Math.random().toString(36);
                systemCall.id = requestId;
                
                log(`üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤: ${systemCall.functionName} (ID: ${requestId})`);
                
                messagePort.addEventListener('message', function onMessage(event) {
                    if (event.data && event.data.id === requestId) {
                        clearTimeout(timeout);
                        messagePort.removeEventListener('message', onMessage);
                        
                        log(`üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤: ${JSON.stringify(event.data, null, 2)}`);
                        
                        resolve({
                            success: !event.data.error,
                            result: event.data.result,
                            error: event.data.error?.message
                        });
                    }
                });
                
                messagePort.postMessage({
                    jsonrpc: "2.0",
                    id: requestId,
                    method: "systemCall",
                    params: [systemCall]
                });
            });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            log('üöÄ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Dust –∫–ª–∏–µ–Ω—Ç—É.');
            log('üí° –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Dust" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.');
        });
    </script>
</body>
</html> 
