<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shop Chest</title>
  <meta name="viewport" content="width=600, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #232526 0%, #414345 100%);
      color: #f3f3f3;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .shop-header {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      padding: 2em 0 1em 0;
      text-align: center;
      box-shadow: 0 2px 8px #0003;
    }
    .shop-header h1 {
      font-size: 2.7em;
      margin: 0 0 0.2em 0;
      letter-spacing: 2px;
      color: #fff;
      text-shadow: 0 2px 8px #0005;
    }
    .shop-header p {
      font-size: 1.2em;
      color: #e0e0e0;
      margin: 0;
      opacity: 0.85;
    }
    .container {
      flex: 1;
      max-width: 700px;
      margin: 0 auto;
      padding: 2em 1em 1em 1em;
    }
    .trade-grid {
      display: grid;
      gap: 2em;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      margin-top: 2em;
    }
    .trade-card {
      background: #292b2f;
      border-radius: 18px;
      box-shadow: 0 4px 24px #0005;
      padding: 2em 1.5em 1.5em 1.5em;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      overflow: hidden;
      border: 1px solid #393b40;
      animation: fadeInUp 0.7s cubic-bezier(.39,.575,.56,1.000);
    }
    .trade-card:hover {
      transform: translateY(-6px) scale(1.03);
      box-shadow: 0 8px 32px #0007;
      border-color: #764ba2;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .trade-title {
      font-size: 1.4em;
      margin-bottom: 0.3em;
      color: #a991e4;
      font-weight: 600;
      letter-spacing: 1px;
    }
    .trade-desc {
      font-size: 1em;
      margin-bottom: 1.2em;
      color: #bdbdbd;
      font-style: italic;
    }
    .trade-exchange {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 1.2em 0 1.5em 0;
      padding: 1em;
      background: #232326;
      border-radius: 10px;
      box-shadow: 0 2px 8px #0002;
    }
    .trade-item {
      text-align: center;
      flex: 1;
    }
    .trade-arrow {
      font-size: 2em;
      color: #667eea;
      margin: 0 18px;
      font-weight: bold;
      text-shadow: 0 1px 4px #0003;
    }
    .item-name {
      font-weight: bold;
      color: #fff;
      font-size: 1.1em;
      margin-bottom: 0.2em;
    }
    .item-amount {
      color: #bdbdbd;
      font-size: 0.95em;
    }
    .trade-button {
      width: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 14px 0;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: bold;
      transition: all 0.2s;
      margin-top: 0.5em;
      box-shadow: 0 2px 8px #0002;
    }
    .trade-button:hover {
      background: #2d3748;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px #0002;
    }
    .refresh-button {
      background: #4a5568;
      color: #e0e0e0;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: bold;
      margin: 10px 0;
      transition: background 0.2s;
    }
    .refresh-button:hover {
      background: #3a404a;
    }
    .trade-button:active {
      transform: translateY(0);
    }
    .status-message {
      margin: 1.5em 0 0.5em 0;
      padding: 1em;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      font-size: 1.05em;
      background: #232326;
      color: #a991e4;
      border: 1px solid #393b40;
      box-shadow: 0 2px 8px #0002;
    }
    footer {
      text-align: center;
      margin-top: 2em;
      color: #a0aec0;
      font-size: 0.9em;
    }
    @media (max-width: 700px) {
      .container {
        padding: 1em 0.2em;
      }
      .trade-grid {
        grid-template-columns: 1fr;
      }
      .trade-exchange {
        flex-direction: column;
        gap: 10px;
      }
      .trade-arrow {
        transform: rotate(90deg);
      }
    }
  </style>
</head>
<body>
  <div class="shop-header">
    <h1>üè™ Shop Chest</h1>
    <p>Trade your items and ETH in the marketplace</p>
  </div>
  <div class="container">
    <div id="status">üè™ Shop Chest is ready for trading!</div>
    <button onclick="refreshUI()" class="refresh-button">üîÑ Refresh</button>
    <div class="trade-grid" id="trades-container"></div>
  </div>
  <footer>
    &copy; 2024 Shop Chest &mdash; Powered by Dust/MUD
  </footer>
  <script>
    // Global variables
    let chestEntityId = '0x03000002bd000000b5fffff97800000000000000000000000000000000000000';
    let playerEntityId = null;
    let world = null;

    // Trade definitions
    const trades = [
      {
        id: 'pumpkin-soup',
        name: 'Pumpkin to Soup',
        description: 'Trade your Pumpkin for delicious PumpkinSoup',
        input: { type: 'item', item: 'Pumpkin', amount: 1, emoji: 'üéÉ' },
        output: { item: 'PumpkinSoup', amount: 1, emoji: 'ü•£' }
      },
      {
        id: 'eth-pumpkin',
        name: 'ETH to Pumpkin',
        description: 'Buy Pumpkin with ETH',
        input: { type: 'eth', amount: '0.000001', emoji: 'üíé' },
        output: { item: 'Pumpkin', amount: 1, emoji: 'üéÉ' },
        ethRequired: 1000000000000
      }
    ];

    // Simple initialization
    async function initializeUI() {
      console.log("Initializing Shop Chest UI...");
      console.log("Chest Entity ID:", chestEntityId);
      
      // Try to get world contract with retries
      let retries = 0;
      const maxRetries = 10;
      
      while (retries < maxRetries) {
        world = window.world || window.dust?.world;
        
        if (world) {
          console.log("World object found:", world);
          break;
        }
        
        console.log(`World object not available, retry ${retries + 1}/${maxRetries}`);
        retries++;
        
        if (retries < maxRetries) {
          // Wait 1 second before retrying
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }
      
      if (!world) {
        console.log("World object still not available after retries");
        showStatus('‚ö†Ô∏è World object not available. Click "Refresh" to retry.');
        return;
      }
      
      // Try to get player entity ID automatically
      await getPlayerEntityId();
      console.log("Player Entity ID:", playerEntityId);
      
      // Load trades
      renderTrades();
      showStatus('üè™ Shop Chest is ready for trading!');
    }

    // Manual refresh function
    function refreshUI() {
      showStatus('üîÑ Refreshing...');
      initializeUI();
    }

    // Update status display
    function updateStatus(message) {
      const statusElement = document.getElementById('status');
      if (statusElement) {
        statusElement.textContent = message;
      }
      console.log("Status:", message);
    }

    // Show status message
    function showStatus(message) {
      updateStatus(message);
    }

    // Render trades
    function renderTrades() {
      const container = document.getElementById('trades-container');
      const tradesHTML = trades.map(trade => `
        <div class="trade-card">
          <div class="trade-title">${trade.name}</div>
          <div class="trade-desc">${trade.description}</div>
          <div class="trade-exchange">
            <div class="trade-item">
              <div class="item-name">${trade.input.emoji} ${trade.input.type === 'item' ? trade.input.item : 'ETH'}</div>
              <div class="item-amount">${trade.input.type === 'item' ? trade.input.amount + 'x' : trade.input.amount}</div>
            </div>
            <div class="trade-arrow">‚Üí</div>
            <div class="trade-item">
              <div class="item-name">${trade.output.emoji} ${trade.output.item}</div>
              <div class="item-amount">${trade.output.amount}x</div>
            </div>
          </div>
          <button class="trade-button" data-trade-id="${trade.id}" onclick="executeTrade('${trade.id}')">
            Make Trade
          </button>
        </div>
      `).join('');
      container.innerHTML = tradesHTML;
    }

    // Execute trade
    async function executeTrade(tradeId) {
      const trade = trades.find(t => t.id === tradeId);
      if (!trade) {
        showStatus('Trade not found!');
        return;
      }

      const button = document.querySelector(`[data-trade-id="${tradeId}"]`);
      button.disabled = true;
      button.textContent = 'Processing...';

      try {
        if (!world) {
          showStatus('‚ùå Error: Could not access world object');
          return;
        }

        if (!playerEntityId) {
          showStatus('‚ùå Error: Could not find player entity ID');
          return;
        }

        // Find player's Pumpkin in inventory for item trades
        if (trade.input.type === 'item') {
          const pumpkinSlot = await findPumpkinSlot(world, playerEntityId);
          
          if (pumpkinSlot === null) {
            showStatus('‚ùå You need Pumpkin to make this trade!');
            return;
          }

          // Execute item trade (Pumpkin ‚Üí PumpkinSoup)
          await world.write("transferAmounts", 
            playerEntityId, // caller
            playerEntityId, // from (player inventory)
            chestEntityId,  // to (chest)
            [[pumpkinSlot, trade.input.amount]] // [slot, amount]
          );
        } else {
          // Execute ETH trade (ETH ‚Üí Pumpkin)
          await world.write("transferAmounts", 
            playerEntityId, // caller
            playerEntityId, // from (player inventory)
            chestEntityId,  // to (chest)
            [], // no items transferred (ETH is sent separately)
            { value: trade.ethRequired } // ETH amount
          );
        }

        showStatus(`‚úÖ Trade completed! You exchanged ${trade.input.emoji} ${trade.input.type === 'item' ? trade.input.amount + 'x ' + trade.input.item : trade.input.amount + ' ETH'} for ${trade.output.emoji} ${trade.output.amount}x ${trade.output.item}`);

      } catch (error) {
        console.error("Trade error:", error);
        showStatus('‚ùå Trade failed: ' + (error.message || 'Unknown error'));
      } finally {
        button.disabled = false;
        button.textContent = 'Make Trade';
      }
    }

    // Function to find Pumpkin in player's inventory
    async function findPumpkinSlot(world, playerEntityId) {
      try {
        // Use the working inventory scanning code
        for (let i = 0; i < 36; i++) {
          try {
            const encodedSlot = "0x" + i.toString(16).padStart(64, '0');
            const slotData = await world.read("getRecord", 
              "0x74620000000000000000000000000000496e76656e746f7279536c6f74000000",
              [playerEntityId, encodedSlot],
            );
            
            const staticData = slotData[0];
            const amount = decodeUint16(staticData);
            const objectType = decodeObjectType(staticData);
            
            if (objectType === 94 && amount > 0) { // Pumpkin ID
              return i;
            }
          } catch (error) {
            // Skip errors
          }
        }
        return null; // No Pumpkin found
      } catch (error) {
        console.error("Error finding Pumpkin:", error);
        return null;
      }
    }

    // Helper function for decoding object type
    function decodeObjectType(staticData) {
      if (staticData === '0x') return 0;
      const objectTypeHex = staticData.slice(-8, -4);
      return parseInt(objectTypeHex, 16);
    }

    // Get player entity ID automatically
    async function getPlayerEntityId() {
      try {
        if (!world) {
          console.log("World contract not available");
          return;
        }
        
        // Try to get player entity ID from window object (set via console)
        if (window.playerEntityId) {
          playerEntityId = window.playerEntityId;
          console.log("Using player entity ID from window:", playerEntityId);
          return;
        }
        
        // Try common player entity IDs
        const possiblePlayerIds = [
          '0x0000000000000000000000000000000000000000000000000000000000000001',
          '0x0000000000000000000000000000000000000000000000000000000000000002',
          '0x0000000000000000000000000000000000000000000000000000000000000003',
          '0x0000000000000000000000000000000000000000000000000000000000000004',
          '0x0000000000000000000000000000000000000000000000000000000000000005'
        ];
        
        for (const testEntityId of possiblePlayerIds) {
          try {
            // Check if this entity has Pumpkin (objectType 94)
            for (let slot = 0; slot < 36; slot++) {
              try {
                const encodedSlot = "0x" + slot.toString(16).padStart(64, '0');
                const slotData = await world.read("getRecord", 
                  "0x74620000000000000000000000000000496e76656e746f7279536c6f74000000",
                  [testEntityId, encodedSlot],
                );
                
                const staticData = slotData[0];
                const amount = decodeUint16(staticData);
                const objectType = decodeObjectType(staticData);
                
                if (objectType === 94 && amount > 0) { // Pumpkin found
                  playerEntityId = testEntityId;
                  console.log("Found player entity ID with Pumpkin:", playerEntityId);
                  return;
                }
              } catch (error) {
                // Skip errors
              }
            }
          } catch (error) {
            // Skip errors
          }
        }
        
        console.log("Could not automatically find player entity ID with Pumpkin");
        console.log("To set player entity ID manually, run in console: window.playerEntityId = 'YOUR_ENTITY_ID'");
        
      } catch (error) {
        console.error("Error getting player entity ID:", error);
      }
    }

    // Helper functions for decoding inventory data
    function decodeUint16(bytesHex) {
      if (bytesHex === '0x') return 0;
      const last4Chars = bytesHex.slice(-4);
      return parseInt(last4Chars, 16);
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      initializeUI();
    });
  </script>
</body>
</html> 
